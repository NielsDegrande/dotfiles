# Functions are defined here and sourced from ~/.zshrc.

# Set SSL_CERT_FILE to the path of certifi's certificate bundle.
certifi() {
  export SSL_CERT_FILE=$(python3 -m certifi)
  echo "SSL_CERT_FILE set to $SSL_CERT_FILE"
}

# Load .env file.
envup () {
  if [ -f .env ]
  then
    set -o allexport; source .env; set +o allexport
  fi
}

# Avoid accidentally pip installing in the base environment.
pip() {
    if [[ -z "$VIRTUAL_ENV" ]]; then
        echo "WARNING: You are not in a virtual environment. Do you want to proceed (y/n)?"
        read -r answer
        if [[ "$answer" != "y" ]]; then
            echo "Aborting pip command."
            return 1
        fi
    fi
    command pip "$@"
}

# Clean python artifacts.
pyclean () {
    find . -type f -name '*.py[co]' -delete
    find . -type d -name __pycache__ -delete
}

# Create a new git worktree with a branch from latest origin/main.
# Usage:
#   worknew <name> [base-branch]       Create new branch niels/<name> from origin/<base-branch>
#   worknew -e <name> <branch>          Checkout existing branch into ../wt-<name>
#   worknew -f <name> [base-branch]    Force recreate (removes existing worktree/branch)
worknew() {
  local force=false existing=false
  local name="" base="main"
  for arg in "$@"; do
    case "$arg" in
      -f|--force) force=true ;;
      -e|--existing) existing=true ;;
      *) [[ -z "$name" ]] && name="$arg" || base="$arg" ;;
    esac
  done
  if [[ -z "$name" ]]; then
    echo "Usage: worknew [-f|--force] [-e|--existing] <name> [base-branch]"
    return 1
  fi
  local wtdir="../wt-$name"
  if $existing; then
    if [[ -z "$base" || "$base" == "main" ]]; then
      echo "Usage: worknew -e <name> <branch>"
      return 1
    fi
    git fetch origin "$base" && \
    git worktree add "$wtdir" "$base" && \
    cd "$wtdir" && \
    direnv allow
  else
    if $force; then
      git worktree remove "$wtdir" 2>/dev/null
      git branch -D "niels/$name" 2>/dev/null
    fi
    git fetch origin "$base" && \
    git worktree add --no-track -b "niels/$name" "$wtdir" "origin/$base" && \
    cd "$wtdir" && \
    direnv allow
  fi
}
